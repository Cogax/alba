<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta name="generator" content="Bootply" />
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Alba - Bootstrapping and Configuration</title>
        <link href="/alba/content/bootstrap.min.css" rel="stylesheet" type="text/css" />
        <link href="/alba/content/prism.css" rel="stylesheet" type="text/css" />
        <link href="/alba/content/theme.css" rel="stylesheet" type="text/css" />

        <link rel="apple-touch-icon" href="/bootstrap/img/apple-touch-icon.png">
        <link rel="apple-touch-icon" sizes="72x72" href="/bootstrap/img/apple-touch-icon-72x72.png">
        <link rel="apple-touch-icon" sizes="114x114" href="/bootstrap/img/apple-touch-icon-114x114.png">

        <link href="/alba/content/affix.css" rel="stylesheet" type="text/css" />
    </head>

    <body>

      <a href="https://github.com/jasperfx/Alba"><img style="z-index: 5000; position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/e7bbb0521b397edbd5fe43e7f760759336b5e05f/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677265656e5f3030373230302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_green_007200.png"></a>

      <nav class="navbar navbar-default navbar-fixed-top" role="banner">
      <div class="container">
        <div class="navbar-header">
          <a href="/alba" class="navbar-brand">Alba</a>
        </div>
        <nav class="collapse navbar-collapse" role="navigation">
          <ul class="nav navbar-nav pull-right">
            <li>
              <a href="/alba/getting_started">Getting Started</a>
            </li>
            <li>
              <a href="/alba/documentation">Documentation</a>
            </li>
            <li>
              <a href="https://gitter.im/jasperfx/Alba?utm_source=badge&amp;utm_medium=badge&amp;utm_campaign=pr-badge&amp;utm_content=badge"><img src="https://camo.githubusercontent.com/da2edb525cde1455a622c58c0effc3a90b9a181c/68747470733a2f2f6261646765732e6769747465722e696d2f4a6f696e253230436861742e737667" alt="Join the chat at https://gitter.im/jasperfx/Alba" data-canonical-src="https://badges.gitter.im/Join%20Chat.svg" style="max-width:100%;"></a>
            </li>
            <li><a href="/alba/documentation" title="Documentation">Previous</a></li>
            <li><a href="/alba/documentation/urls" title="Working with Url's">Next</a></li>
          </ul>
          <div class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <input id="search" type="search" class="form-control" placeholder="Search">
            </div>
          </div>

        </nav>

      </div>
    </nav>

    <div class="container">
      <nav class="navbar-inverse">
        <ol class="breadcrumb"><li><a href="/alba/">Alba</a></li><li><a href="/alba/documentation">Documentation</a></li><li class="active">Bootstrapping and Configuration</li></ol>
      </nav>
    </div>

    <!--main-->
    <div class="container">
      <div class="row">
          <!--left-->
          <div class="col-md-3" id="leftCol">
            <h3>Alba 1.2.0</h3>
            <br />

            <ul class="nav nav-stacked affix" id="sidebar">
            </ul>

            <h3 class="no-margin">Next</h3><p><a href="/alba/documentation/urls">Working with Url's</a></p>
            <h3 class="no-margin">Previous</h3><a href="/alba/documentation">Documentation</a></p>
          </div><!--/left-->

          <!--right-->
          <div class="col-md-9">
              <h1>Bootstrapping and Configuration</h1>

              <hr />

              <div id="main-pane">
                <!--title: Bootstrapping and Configuration-->
<p>Alba uses its <code>SystemUnderTest</code> class to manage the lifecycle of an ASP.Net Core application. The easiest way to use this
class is to directly use the <code>Startup</code> class for your application like so:</p>
<pre><code class="language-csharp">&#xA;var system = SystemUnderTest.ForStartup&lt;Startup&gt;();&#xA;</code></pre>
<p>Alba won't bootstrap your application until the first time you try to execute a <em>Scenario</em>, so you have the option
to apply additional configuration to how the system under test will execute.</p>
<h2 id="running-a-scenario">Running a Scenario</h2>
<p>Once you have a <code>SystemUnderTest</code> object, you're ready to execute <em>Scenario's</em> through your system inside of tests.
Below is a scenario for the &quot;hello, world&quot; application:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public Task should_say_hello_world()&#xA;{&#xA;    using (var system = SystemUnderTest.ForStartup&lt;Startup&gt;())&#xA;    {&#xA;        // This runs an HTTP request and makes an assertion&#xA;        // about the expected content of the response&#xA;        return system.Scenario(_ =&gt;&#xA;        {&#xA;            _.Get.Url(&quot;/&quot;);&#xA;            _.ContentShouldBe(&quot;Hello, World!&quot;);&#xA;            _.StatusCodeShouldBeOk();&#xA;        });&#xA;    }&#xA;}&#xA;</code></pre>
<p>The <code>Scenario()</code> method has this signature:</p>
<pre><code class="language-csharp">&#xA;/// &lt;summary&gt;&#xA;/// Define and execute an integration test by running an Http request through&#xA;/// your ASP.Net Core system&#xA;/// &lt;/summary&gt;&#xA;/// &lt;param name=&quot;system&quot;&gt;&lt;/param&gt;&#xA;/// &lt;param name=&quot;configure&quot;&gt;&lt;/param&gt;&#xA;/// &lt;returns&gt;&lt;/returns&gt;&#xA;/// &lt;exception cref=&quot;InvalidOperationException&quot;&gt;&lt;/exception&gt;&#xA;public static async Task&lt;IScenarioResult&gt; Scenario(&#xA;    this ISystemUnderTest system,&#xA;    Action&lt;Scenario&gt; configure)&#xA;</code></pre>
<p>The single <code>Action&lt;Scenario&gt;</code> argument should completely configure the ASP.Net <code>HttpContext</code> for the request and apply
any of the declarative response assertions. The actual HTTP request happens inside of the <code>Scenario()</code> method, and the response contains the raw <code>HttpContext</code> and a helper object to work with the response body:</p>
<pre><code class="language-csharp">&#xA;public interface IScenarioResult&#xA;{&#xA;    /// &lt;summary&gt;&#xA;    /// Helpers to interrogate or read the HttpResponse.Body&#xA;    /// of the request&#xA;    /// &lt;/summary&gt;&#xA;    HttpResponseBody ResponseBody { get; }&#xA;&#xA;    /// &lt;summary&gt;&#xA;    /// The raw HttpContext used during the scenario&#xA;    /// &lt;/summary&gt;&#xA;    HttpContext Context { get; }&#xA;}&#xA;</code></pre>
<p>If the existing <em>Scenario</em> assertions aren't enough to verify your test case, you can work directly against the raw response:</p>
<pre><code class="language-csharp">&#xA;[Fact]&#xA;public async Task should_say_hello_world_with_raw_objects()&#xA;{&#xA;    using (var system = SystemUnderTest.ForStartup&lt;Startup&gt;())&#xA;    {&#xA;        var response = await system.Scenario(_ =&gt;&#xA;        {&#xA;            _.Get.Url(&quot;/&quot;);&#xA;            _.StatusCodeShouldBeOk();&#xA;        });&#xA;&#xA;        response.ResponseBody.ReadAsText()&#xA;            .ShouldBe(&quot;Hello, World!&quot;);&#xA;&#xA;        // or you can go straight at the HttpContext&#xA;        // The ReadAllText() extension method is from Baseline&#xA;&#xA;&#xA;        var body = response.Context.Response.Body;&#xA;        body.Position = 0; // need to rewind it because we read it above&#xA;        body.ReadAllText().ShouldBe(&quot;Hello, World!&quot;);&#xA;    }&#xA;}&#xA;</code></pre>
<p>Do note that Alba quietly &quot;rewinds&quot; the <code>HttpContext.Response.Body</code> stream so that you can more readily read and work with the contents.</p>
<h2 id="bootstrapping-without-startup">Bootstrapping without Startup</h2>
<p>It's a little bit uglier, but you can bypass having a <code>Startup</code> code and work directly against the ASP.Net Core <code>IWebHostBuilder</code>
interface like this:</p>
<pre><code class="language-csharp">&#xA;var system = SystemUnderTest.For(_ =&gt;&#xA;{&#xA;    _.Configure(app =&gt;&#xA;    {&#xA;        app.Run(c =&gt;&#xA;        {&#xA;            return c.Response.WriteAsync(&quot;Hello, World!&quot;);&#xA;        });&#xA;    });&#xA;});&#xA;</code></pre>
<h2 id="the-hosting-environment">The Hosting Environment</h2>
<p>By default, Alba will try to guess the content root path by trying to find a directory &quot;parallel&quot; to the current testing project
that matches the name of the Assembly that contains the designated <code>Startup</code> class. To make that concrete, say that your
web application is in the directory <code>src/MyWebApp</code> and you are running the Alba tests in a project at <code>src/MyWebApp.Tests</code>.
In this case, Alba is able to find and apply the <code>src/MyWebApp</code> directory as the matching content root path. Otherwise, it just
uses the current directory and you may have to help Alba out a little bit by modifying the <code>IHostingEnvironment</code> for the application.</p>
<p>You can customize the <a href="https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.hosting.ihostingenvironment">hosting environment</a> settings like so:</p>
<pre><code class="language-csharp">&#xA;system.Environment.ApplicationName = &quot;My Application&quot;;&#xA;system.Environment.ContentRootPath = &quot;c:\\somewhere\\else&quot;;&#xA;</code></pre>
<p>Alba does not set any default value for the <code>EnvironmentName</code> property.</p>
<h2 id="hosting-and-other-configuration">Hosting and Other Configuration</h2>
<p>If you also want to run real HTTP requests through your system in a test harness, you have more opportunities to configure the underlying <a href="https://docs.microsoft.com/en-us/aspnet/core/api/microsoft.aspnetcore.hosting.iwebhostbuilder">IWebHostBuilder</a> like so:</p>
<pre><code class="language-csharp">&#xA;system.Configure(builder =&gt;&#xA;{&#xA;    builder&#xA;        .UseKestrel()&#xA;        .UseUrls(&quot;http://localhost:5025&quot;);&#xA;});&#xA;</code></pre>
<p>My shop is also using Alba within <a href="http://storyteller.github.io">Storyteller</a> specifications where we use a mix of headless
Alba Scenario's and full HTTP requests for testing.</p>
<h2 id="service-registrations">Service Registrations</h2>
<p>Maybe more commonly, you'll want to override the default service registrations with controlled stubs for your tests. In my shop's case, one of our biggest systems interacts with an external web service that would be very problematic in controlled automated
testing scenarios. In order to reliably test <strong>our</strong> application, we override the service gateway wrapper with a stubbed version that
can be easily controlled within the test harness. In Alba, you can use <code>SystemUnderTest.ConfigureServices()</code> to make service registration changes:</p>
<pre><code class="language-csharp">&#xA;system.ConfigureServices(services =&gt;&#xA;{&#xA;    services.AddTransient&lt;IExternalService, StubbedExternalService&gt;();&#xA;});&#xA;</code></pre>
<h2 id="best-practices">Best Practices</h2>
<p>Spinning up your ASP.Net Core system can become slow as the application grows, so you probably want to share the instance of
<code>SystemUnderTest</code> between unit tests to avoid the cost of constantly bootstrapping and tearing down the underlying application.
As an example, if you're an xUnit user, you can take advantage of their <a href="https://xunit.github.io/docs/shared-context.html">shared context</a> support to manage the lifetime of your <code>SystemUnderTest</code>.</p>

              </div>

              <hr />

              <nav>
                <span>
                  <strong>Previous: </strong><a href="/alba/documentation">Documentation</a>

                </span>
                <span class="pull-right">

                  <strong>Next: </strong><a href="/alba/documentation/urls">Working with Url's</a>

                </span>
              </nav>

          </div><!--/right-->
        </div><!--/row-->
      </div><!--/container-->

    </body>


    <footer>
        <script type='text/javascript' src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script type='text/javascript' src="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <script type="text/javascript" src="/alba/content/prism.js"></script>
        <script type="text/javascript" src="/alba/content/sidebar.js"></script>
        <script type="text/javascript" src="/alba/content/affix.js"></script>

<script>
$('#search').keyup(function(e){
  if(e.keyCode == 13) {
    var search = $('#search').val();

    var url = 'https://www.google.com/#q=site:jasperfx.github.io ' + search;
    url = encodeURI(url);

    window.location.href = url;

    e.stopPropagation();
    if (e.cancelBubble!=null) e.cancelBubble = true;
    return false;
  }
});
</script>
    </footer>
</html>
